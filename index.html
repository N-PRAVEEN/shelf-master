<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="theme-color" content="#007bff">
    <title>Shelf Master</title>

    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEwMCIgZmlsbD0iIzAwN2JmZiIvPjxwYXRoIGZpbGw9IiNmZmYiIGQ9Ik0xMDYgMTQwaDMwMHY1MEgxMDZ6bTAgMTEwaDMwMHY1MEgxMDZ6bTAgMTEwaDMwMHY1MEgxMDZ6Ii8+PC9zdmc+">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEwMCIgZmlsbD0iIzAwN2JmZiIvPjxwYXRoIGZpbGw9IiNmZmYiIGQ9Ik0xMDYgMTQwaDMwMHY1MEgxMDZ6bTAgMTEwaDMwMHY1MEgxMDZ6bTAgMTEwaDMwMHY1MEgxMDZ6Ii8+PC9zdmc+">

    <script>
        const iconBase64 = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEwMCIgZmlsbD0iIzAwN2JmZiIvPjxwYXRoIGZpbGw9IiNmZmYiIGQ9Ik0xMDYgMTQwaDMwMHY1MEgxMDZ6bTAgMTEwaDMwMHY1MEgxMDZ6bTAgMTEwaDMwMHY1MEgxMDZ6Ii8+PC9zdmc+";
        const manifest = {
            "name": "Shelf Master",
            "short_name": "ShelfMaster",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#007bff",
            "orientation": "portrait",
            "icons": [{ "src": iconBase64, "sizes": "512x512", "type": "image/svg+xml" }]
        };
        const linkManifest = document.createElement('link');
        linkManifest.rel = 'manifest';
        linkManifest.href = 'data:application/manifest+json;base64,' + btoa(JSON.stringify(manifest));
        document.head.appendChild(linkManifest);
    </script>

    <meta name="mobile-web-app-capable" content="yes">
    <style>
        :root { --primary: #007bff; --danger: #dc3545; --success: #28a745; --text-dark: #333; --text-light: #666; --bg-light: #f8f9fa; --border: #e9ecef; --shadow: 0 2px 5px rgba(0,0,0,0.1); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #fff; color: var(--text-dark); padding-bottom: 80px; }

        /* Header Layout */
        header { position: sticky; top: 0; z-index: 100; background: white; box-shadow: var(--shadow); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--primary); color: white; }
        .header-actions { display: flex; align-items: center; gap: 8px; }

        /* Header Buttons */
        .icon-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 5px; }
        .btn { border: none; padding: 6px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-primary { background: var(--primary); color: white; padding: 10px 15px; font-size: 14px; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 10px 15px; font-size: 14px; }

        /* 3-Dots Dropdown Menu */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; right: 0; background-color: #f9f9f9; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 4px; overflow: hidden; }
        .dropdown-content a { color: black; padding: 12px 16px; text-decoration: none; display: block; font-size: 14px; }
        .dropdown-content a:active { background-color: #ddd; }
        .show { display: block; }

        /* Google Translate & Controls */
        #google_translate_element { padding: 8px 15px; text-align: center; background: #f8f9fa; border-bottom: 1px solid var(--border); }
        .goog-te-gadget-simple { background-color: white !important; border: 1px solid #ccc !important; padding: 6px !important; border-radius: 4px; width: 100%; }
        
        .controls { padding: 10px; display: grid; grid-template-columns: 1fr 130px; gap: 10px; background: #fff; border-bottom: 1px solid var(--border); }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; outline: none; }
        
        /* Coloring Logic */
        .product-row.filled { background-color: #f0fff4; } 
        #filter-select option[value="completed"] { background-color: #d4edda; color: #155724; font-weight: bold; }
        #filter-select option[value="pending"] { background-color: #ffffff; color: #333; }

        /* List Styling */
        #product-list { list-style: none; padding: 0; margin: 0; }
        .product-row { display: grid; grid-template-columns: 60px 1fr 90px; gap: 15px; padding: 15px; border-bottom: 1px solid var(--border); align-items: center; background: white; transition: background-color 0.2s; user-select: none; }
        .p-img-wrapper { width: 60px; height: 60px; border-radius: 12px; overflow: hidden; background: #eee; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border); cursor: pointer; }
        .p-img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; } 
        .p-details { overflow: hidden; }
        .p-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .p-unit { font-size: 12px; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; background: var(--bg-light); padding: 2px 6px; border-radius: 4px; display: inline-block; }
        mark { background-color: #ffeeba; color: var(--text-dark); padding: 0 2px; }
        
        .p-qty-input { width: 100%; height: 50px; text-align: center; font-size: 18px; font-weight: bold; border: 2px solid var(--border); background: #fdfdfd; }
        .p-qty-input:focus { border-color: var(--primary); background: #fff; }
        .p-qty-input.filled { border-color: var(--success); color: var(--success); background: #fff; border-width: 2px; }

        /* Fab & Modal */
        .fab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 200; border:none; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; width: 90%; max-width: 400px; border-radius: 12px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px; }
        .toggle-wrapper { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }
        #preview-container { width: 100%; height: 150px; background: #eee; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; border: 2px dashed #ccc; }
        #preview-img { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* --- IMAGE VIEWER (ZOOM) STYLES --- */
        .image-viewer {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* Important for custom pan logic */
            background-color: rgba(0,0,0,0.95);
            touch-action: none; /* Disable browser handling of gestures */
            align-items: center;
            justify-content: center;
        }
        .image-viewer.active { display: flex; }
        .viewer-content {
            max-width: 100%;
            max-height: 100%;
            transform-origin: center center;
            transition: transform 0.1s linear; /* Smooth pan/zoom */
            will-change: transform;
        }
    </style>
</head>
<body>
    <header>
        <div class="top-bar">
            <h3>Shelf Master</h3>
            <div class="header-actions">
                <button class="icon-btn" id="export-btn" title="Export as PDF">ðŸ“„</button>
                <button class="btn btn-danger" id="reset-day-btn">Reset Day</button>
                <div class="dropdown">
                    <button onclick="toggleMenu()" class="icon-btn dropbtn">â‹®</button>
                    <div id="myDropdown" class="dropdown-content">
                        <a href="#" id="csv-export-btn">Export as CSV</a>
                        <a href="#" id="backup-btn">Backup Data</a>
                        <a href="#" id="restore-btn">Restore Data</a>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="google_translate_element"></div>
        
        <div class="controls">
            <input type="text" id="search-input" placeholder="Search products...">
            <select id="filter-select">
                <option value="all">Show All</option>
                <option value="pending">Pending</option>
                <option value="completed">Completed</option>
            </select>
        </div>
    </header>

    <ul id="product-list"></ul>
    <button class="fab" id="open-add-modal">+</button>

    <input type="file" id="restore-input" accept=".json" class="hidden">

    <div class="modal" id="add-modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 15px;">Add Product</h2>
            <div id="preview-container" onclick="document.getElementById('file-input').click()">
                <span id="preview-text" style="color:#888;">Tap to Upload/Capture</span>
                <img id="preview-img" class="hidden">
            </div>
            <input type="file" id="file-input" accept="image/*" class="hidden">
            
            <div class="form-group">
                <label class="form-label">Product Name</label>
                <input type="text" id="p-name-input" placeholder="e.g. Milk, Rice">
            </div>

            <div class="form-group">
                <label class="form-label">Unit Type</label>
                <div class="toggle-wrapper">
                    <span id="unit-label-count" style="font-weight:bold; color:var(--primary);">Count</span>
                    <label class="switch">
                        <input type="checkbox" id="unit-toggle">
                        <span class="slider"></span>
                    </label>
                    <span id="unit-label-kg" style="color:#ccc;">KG</span>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Initial Quantity (Optional)</label>
                <input type="number" id="p-initial-qty" placeholder="Leave empty for pending" step="1">
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-outline" style="flex:1" id="cancel-add">Cancel</button>
                <button class="btn btn-primary" style="flex:1" id="save-product">Save</button>
            </div>
        </div>
    </div>

    <div id="image-viewer" class="image-viewer">
        <img class="viewer-content" id="full-image">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'en,kn,ml',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element');
        }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

    <script>
        const DB_NAME = 'ShelfMasterDB';
        const DB_VERSION = 1;
        let db;
        let productData = [];
        let currentImageBlob = null;
        let activeObjectUrls = [];
        const el = (id) => document.getElementById(id);
        const { jsPDF } = window.jspdf;

        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains('products')) db.createObjectStore('products', { keyPath: 'id' });
            };
            request.onsuccess = (e) => { db = e.target.result; loadProducts(); };
        }

        // --- MENU LOGIC ---
        function toggleMenu() { document.getElementById("myDropdown").classList.toggle("show"); }
        window.onclick = function(event) {
            if (!event.target.matches('.dropbtn')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    if (dropdowns[i].classList.contains('show')) dropdowns[i].classList.remove('show');
                }
            }
        }

        // --- IMAGE VIEWER ZOOM LOGIC (PINCH & PAN) ---
        const imageViewer = el('image-viewer');
        const fullImage = el('full-image');
        
        // Zoom State Variables
        let state = {
            scale: 1,
            panning: false,
            pointX: 0,
            pointY: 0,
            startX: 0,
            startY: 0
        };

        function setTransform() {
            fullImage.style.transform = `translate(${state.pointX}px, ${state.pointY}px) scale(${state.scale})`;
        }

        function openImageViewer(src) {
            fullImage.src = src;
            imageViewer.classList.add('active');
            // Reset Zoom State
            state = { scale: 1, panning: false, pointX: 0, pointY: 0, startX: 0, startY: 0 };
            setTransform();
        }

        function closeImageViewer() {
            imageViewer.classList.remove('active');
        }

        // Event Listeners for Zooming/Panning
        let startDist = 0;
        let startScale = 1;

        imageViewer.addEventListener('click', (e) => {
            if (e.target === imageViewer) closeImageViewer(); // Close on background click
        });
        
        // Double tap to reset
        let lastTap = 0;
        fullImage.addEventListener('touchend', (e) => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 300 && tapLength > 0) {
                // Double tap detected
                state = { scale: 1, panning: false, pointX: 0, pointY: 0, startX: 0, startY: 0 };
                setTransform();
                e.preventDefault();
            }
            lastTap = currentTime;
        });

        imageViewer.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                // Pinch starts
                e.preventDefault(); 
                startDist = Math.hypot(
                    e.touches[0].pageX - e.touches[1].pageX,
                    e.touches[0].pageY - e.touches[1].pageY
                );
                startScale = state.scale;
            } else if (e.touches.length === 1) {
                // Pan starts
                state.startX = e.touches[0].clientX - state.pointX;
                state.startY = e.touches[0].clientY - state.pointY;
                state.panning = true;
            }
        });

        imageViewer.addEventListener('touchmove', (e) => {
            e.preventDefault(); // Stop screen scrolling
            if (e.touches.length === 2) {
                // Pinching
                const dist = Math.hypot(
                    e.touches[0].pageX - e.touches[1].pageX,
                    e.touches[0].pageY - e.touches[1].pageY
                );
                // Calculate new scale
                let newScale = startScale * (dist / startDist);
                // Limit zoom levels (0.5x to 5x)
                state.scale = Math.min(Math.max(0.5, newScale), 5);
                setTransform();
            } else if (e.touches.length === 1 && state.panning && state.scale > 1) {
                // Panning (only if zoomed in)
                state.pointX = e.touches[0].clientX - state.startX;
                state.pointY = e.touches[0].clientY - state.startY;
                setTransform();
            }
        });

        imageViewer.addEventListener('touchend', () => { state.panning = false; });


        // --- EXPORT & IMPORT LOGIC ---
        function exportAsCSV() {
            const completedItems = productData.filter(p => p.filled);
            if(completedItems.length === 0) return alert("No completed items to export.");
            let csvContent = "data:text/csv;charset=utf-8,Product Name,Quantity,Unit\n";
            completedItems.forEach(p => { csvContent += `${p.name},${p.quantity},${p.unit}\n`; });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "ShelfMaster_Report_" + new Date().toISOString().slice(0,10) + ".csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        el('csv-export-btn').onclick = exportAsCSV;

        el('export-btn').onclick = () => {
            const listElement = el('product-list');
            const fab = el('open-add-modal');
            fab.style.display = 'none';
            html2canvas(document.body, { 
                scale: 2, 
                useCORS: true, 
                scrollX: 0,
                scrollY: -window.scrollY 
            }).then(canvas => {
                fab.style.display = 'flex';
                const imgData = canvas.toDataURL('image/jpeg', 0.9);
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgProps= pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                pdf.save("ShelfMaster_List_" + new Date().toISOString().slice(0,10) + ".pdf");
            });
        };

        el('backup-btn').onclick = async () => {
            const exportData = await Promise.all(productData.map(async (p) => {
                let base64Img = null;
                if(p.image) {
                    base64Img = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.readAsDataURL(p.image);
                    });
                }
                return { ...p, image: base64Img };
            }));
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "ShelfMaster_Backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        };

        el('restore-btn').onclick = () => el('restore-input').click();
        
        el('restore-input').onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if(!Array.isArray(importedData)) throw new Error("Invalid file");
                    if(!confirm(`Found ${importedData.length} items. Restore? (Current data will be replaced)`)) return;
                    
                    const tx = db.transaction(['products'], 'readwrite');
                    tx.objectStore('products').clear();
                    importedData.forEach(async (item) => {
                        let blob = null;
                        if(item.image && typeof item.image === 'string') {
                            const res = await fetch(item.image);
                            blob = await res.blob();
                        }
                        const newItem = { id: item.id || Date.now(), name: item.name, image: blob, unit: item.unit, quantity: item.quantity, filled: item.filled };
                        const addTx = db.transaction(['products'], 'readwrite');
                        addTx.objectStore('products').put(newItem);
                    });
                    setTimeout(() => { alert("Restore Successful!"); loadProducts(); }, 1000);
                } catch(err) { alert("Error restoring file: " + err); }
            };
            reader.readAsText(file);
        };

        // --- ADD/COMPRESS/SAVE LOGIC ---
        el('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 120; 
                    let width = img.width; let height = img.height;
                    if (width > maxWidth) { height = (maxWidth / width) * height; width = maxWidth; }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob((blob) => {
                        currentImageBlob = blob;
                        el('preview-img').src = URL.createObjectURL(blob);
                        el('preview-img').classList.remove('hidden');
                        el('preview-text').classList.add('hidden');
                    }, 'image/jpeg', 0.5); 
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        const modal = el('add-modal');
        const unitToggle = el('unit-toggle');
        el('open-add-modal').onclick = () => { modal.classList.add('active'); resetForm(); };
        el('cancel-add').onclick = () => modal.classList.remove('active');
        unitToggle.addEventListener('change', () => {
            const qtyInput = el('p-initial-qty');
            if(unitToggle.checked) {
                el('unit-label-kg').style.color = 'var(--primary)'; el('unit-label-kg').style.fontWeight = 'bold';
                el('unit-label-count').style.color = '#ccc'; el('unit-label-count').style.fontWeight = 'normal';
                qtyInput.step = "0.01"; 
            } else {
                el('unit-label-kg').style.color = '#ccc'; el('unit-label-kg').style.fontWeight = 'normal';
                el('unit-label-count').style.color = 'var(--primary)'; el('unit-label-count').style.fontWeight = 'bold';
                qtyInput.step = "1";
            }
        });

        function resetForm() {
            el('p-name-input').value = ''; el('file-input').value = ''; el('p-initial-qty').value = '';
            el('preview-img').src = ''; el('preview-img').classList.add('hidden'); el('preview-text').classList.remove('hidden');
            currentImageBlob = null; unitToggle.checked = false; unitToggle.dispatchEvent(new Event('change'));
        }

        el('save-product').onclick = () => {
            const name = el('p-name-input').value.trim();
            if (!name) return alert('Product Name is required');
            const initQtyStr = el('p-initial-qty').value.trim();
            let finalQty = null; let isFilled = false;
            if (initQtyStr !== '') { finalQty = parseFloat(initQtyStr); isFilled = true; }
            const newProduct = { id: Date.now(), name: name, image: currentImageBlob, unit: unitToggle.checked ? 'kg' : 'count', quantity: finalQty, filled: isFilled };
            const tx = db.transaction(['products'], 'readwrite');
            tx.objectStore('products').add(newProduct);
            tx.oncomplete = () => { modal.classList.remove('active'); loadProducts(); };
        };

        async function loadProducts() {
            const tx = db.transaction(['products'], 'readonly');
            const req = tx.objectStore('products').getAll();
            req.onsuccess = () => { productData = req.result; productData.sort((a, b) => a.name.localeCompare(b.name)); renderList(); };
        }

        function renderList() {
            const list = el('product-list');
            const searchVal = el('search-input').value.toLowerCase();
            const filterVal = el('filter-select').value;
            
            activeObjectUrls.forEach(url => URL.revokeObjectURL(url));
            activeObjectUrls = [];

            list.innerHTML = '';
            
            productData.forEach(p => {
                if (searchVal && !p.name.toLowerCase().includes(searchVal)) return;
                if (filterVal === 'pending' && p.filled) return;
                if (filterVal === 'completed' && !p.filled) return;
                
                const li = document.createElement('li');
                li.className = `product-row ${p.filled ? 'filled' : ''}`; 
                li.dataset.id = p.id;
                
                let imgUrl = '';
                if (p.image) {
                    imgUrl = URL.createObjectURL(p.image);
                    activeObjectUrls.push(imgUrl);
                }

                let displayName = searchVal ? p.name.replace(new RegExp(`(${searchVal})`, 'gi'), '<mark>$1</mark>') : p.name;
                const step = p.unit === 'kg' ? '0.01' : '1';
                const qtyValue = p.quantity !== null ? p.quantity : '';
                const filledClass = p.filled ? 'filled' : '';
                
                li.innerHTML = `
                    <div class="p-img-wrapper">${imgUrl ? `<img src="${imgUrl}" class="p-img">` : `<span class="p-img-placeholder">ðŸ“·</span>`}</div>
                    <div class="p-details"><div class="p-name">${displayName}</div><span class="p-unit">${p.unit}</span></div>
                    <div><input type="number" step="${step}" class="p-qty-input ${filledClass} notranslate" value="${qtyValue}" placeholder="-" data-id="${p.id}"></div>
                `;

                if (imgUrl) {
                    const imgWrapper = li.querySelector('.p-img-wrapper');
                    imgWrapper.onclick = (e) => {
                        e.stopPropagation(); 
                        openImageViewer(imgUrl);
                    };
                }

                const input = li.querySelector('input');
                input.addEventListener('blur', (e) => updateQuantity(p.id, e.target.value));
                setupLongPress(li, p.id);
                list.appendChild(li);
            });
        }

        function updateQuantity(id, val) {
            const tx = db.transaction(['products'], 'readwrite');
            const store = tx.objectStore('products');
            store.get(id).onsuccess = (e) => {
                const data = e.target.result;
                if (!data) return;
                if (val === '') { data.quantity = null; data.filled = false; } 
                else { data.quantity = parseFloat(val); data.filled = true; }
                store.put(data);
                const localP = productData.find(p => p.id === id);
                if(localP) { localP.quantity = data.quantity; localP.filled = data.filled; }
                const row = document.querySelector(`li[data-id="${id}"]`);
                const inputEl = row.querySelector('input');
                if(data.filled) { row.classList.add('filled'); inputEl.classList.add('filled'); } 
                else { row.classList.remove('filled'); inputEl.classList.remove('filled'); }
            };
        }

        el('reset-day-btn').onclick = () => {
            if(!confirm("Reset all quantities for a new day? Images will be KEPT.")) return;
            const tx = db.transaction(['products'], 'readwrite');
            const store = tx.objectStore('products');
            store.openCursor().onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    const record = cursor.value;
                    record.quantity = null; record.filled = false;       
                    cursor.update(record);
                    cursor.continue();
                } else { loadProducts(); }
            };
        };

        el('search-input').addEventListener('input', renderList);
        el('filter-select').addEventListener('change', renderList);

        function setupLongPress(element, id) {
            let timer;
            const start = () => { timer = setTimeout(() => { if(confirm("Delete product?")) deleteProduct(id); }, 800); };
            const end = () => { if (timer) clearTimeout(timer); };
            element.addEventListener('touchstart', start); element.addEventListener('touchend', end);
            element.addEventListener('mousedown', start); element.addEventListener('mouseup', end);
            element.addEventListener('touchmove', end);
            element.addEventListener('contextmenu', e => { e.preventDefault(); e.stopPropagation(); return false; });
        }

        function deleteProduct(id) {
            const tx = db.transaction(['products'], 'readwrite');
            tx.objectStore('products').delete(id);
            tx.oncomplete = () => {
                const row = document.querySelector(`li[data-id="${id}"]`);
                if(row) { row.classList.add('deleting'); setTimeout(loadProducts, 300); } else { loadProducts(); }
            };
        }
        initDB();
    </script>
</body>
</html>
